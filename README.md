# Image Management API

Этот проект представляет собой микросервисное приложение для управления изображениями, с разделением на сервисы авторизации и работы с изображениями. Сервис поддерживает такие функции, как загрузка, обновление и удаление изображений, и использует RabbitMQ для отправки событий об изменениях изображений другим сервисам.

## Технологии

- **Python 3.11** + **FastAPI** для создания API
- **PostgreSQL** для хранения данных
- **RabbitMQ** в качестве брокера сообщений
- **Docker** и **Docker Compose** для контейнеризации и управления зависимостями

## Структура проекта

```plaintext
test_abol/
├── docker/                  # Docker файлы для контейнеризации
│   ├── ImageApi.Dockerfile
│   ├── MainApi.Dockerfile
├── packages/                # Пакеты с кодом
│   └── backend/
│       ├── apps/
│       │   ├── image_service/
│       │   ├── libs/
│       │   └── main_api/
│       └── tests/          # Тесты для микросервисов
│           └── init.py
├── storage/                 # Хранилище для загруженных изображений
├── .gitignore               # Игнорируемые файлы для Git
├── alembic.ini             # Конфигурация для Alembic
├── docker-compose.yml       # Конфигурация Docker Compose
├── README.md                # Документация проекта
└── requirements.txt         # Зависимости проекта
```

•	apps/libs/auth/ — логика авторизации (JWT).

•	apps/libs/config/ — конфигурационные файлы.

•	apps/libs/database/ — модели и подключение к базе данных.

•	apps/libs/broker/ — модуль для отправки сообщений через RabbitMQ.

•	main_api/ — сервис для авторизации.

•	image_service/ — сервис для управления изображениями.

•	docker/ — Dockerfile для обоих сервисов.

•	tests/ — тесты.

# Настройка проекта Image Management API

## Шаг 1: Клонирование репозитория

Сначала клонируйте репозиторий проекта на свою локальную машину:

```bash
git clone git@github.com:Dobrovera/Image_managment_api.git
```

## Шаг 2: Создание и настройка .env файла

Создайте файл .env в корне проекта и добавьте в него следующие переменные окружения. Эти переменные будут использоваться для настройки подключения к базе данных, JWT-секрету и RabbitMQ.

Пример .env файла:
```
# Database настройки
DATABASE_URL=postgresql://<username>:<password>@db:5432/<dbname>
POSTGRES_USER=<username>
POSTGRES_PASSWORD=<password>
POSTGRES_DB=<dbname>

# JWT секрет для токенов авторизации
JWT_SECRET=<ваш_jwt_секрет>

# RabbitMQ настройки (необязательно)
RABBITMQ_HOST=rabbitmq
RABBITMQ_PORT=5672
RABBITMQ_QUEUE=image_events
```

Замените все <значения> на актуальные значения.

## Шаг 3: Запуск из корня проекта
```
docker-compose up --build
```


После выполнения этой команды будут запущены следующие контейнеры:

	•	web_app на порту 8000 — сервис авторизации
	•	image_service — сервис для работы с изображениями
	•	db — PostgreSQL для хранения данных
	•	rabbitmq на портах 5672 и 15672 — брокер сообщений для передачи событий

## Документация API

Документация API будет доступна после запуска контейнеров по адресу: localhost:you_port/docs

## Основные методы API

### 1. Регистрация пользователя

- **URL:** `/auth/register`
- **Метод:** `POST`
- **Описание:** Регистрация нового пользователя.
- **Тело запроса:**
    ```json
    {
        "username": "string",
        "password": "string"
    }
    ```
  Пароль верифицируется и должен быть от 4 до 50 знаков и содержать хотя бы один специальный символ: "!@#$%^&*()_+[]{}|;:',.<>/?"
- **Ответ:**
    - **200 OK:** Пользователь успешно зарегистрирован.
    - **400 Bad Request:** Ошибка валидации данных.

### 2. Вход пользователя

- **URL:** `/auth/login`
- **Метод:** `POST`
- **Описание:** Получение токена доступа для авторизованного пользователя.
- **Тело запроса:**
    ```json
    {
        "username": "string",
        "password": "string"
    }
    ```
- **Ответ:**
    - **200 OK:** Токен доступа получен.
    ```json
    {
        "access_token": "string",
        "token_type": "bearer"
    }
    ```
    - **401 Unauthorized:** Неверные учетные данные.

### 3. Загрузка изображения

- **URL:** `/image/upload_image`
- **Метод:** `POST`
- **Описание:** Загрузка нового изображения и отправка его на обработку.
- **Заголовки:**
    - `Authorization: Bearer {token}`
- **Форма данных:**
    - `image`: файл изображения
- **Ответ:**
    - **200 OK:** Запрос на загрузку изображения отправлен на обработку.
    - **401 Unauthorized:** Необходима авторизация.

### 4. Получение всех изображений

- **URL:** `/image/get_all_images`
- **Метод:** `GET`
- **Описание:** Получение списка всех загруженных изображений.
- **Заголовки:**
    - `Authorization: Bearer {token}`
- **Ответ:**
    - **200 OK:** Список изображений.
    ```json
    [
        {
            "id": 1,
            "title": "name.png",
            "resolution": "1920x1080",
            "size": 204800,
            "file_path": "storage/name.png",
            "created_at": "2024-11-02T18:10:16.510939",
            "user_id": 1
        },
        ...
    ]
    ```
    - **401 Unauthorized:** Необходима авторизация.

### 5. Обновление изображения

- **URL:** `/image/update/{image_id}`
- **Метод:** `PUT`
- **Описание:** Обновление информации об изображении.
- **Заголовки:**
    - `Authorization: Bearer {token}`
- **Параметры URL:**
    - `image_id`: идентификатор изображения
- **Тело запроса:**
    ```json
    {
        "title": "new_name.png",
        "resolution": "1920x1080"
    }
    ```
- **Ответ:**
    - **200 OK:** Запрос на изменение изображения отправлен на обработку.
    - **401 Unauthorized:** Необходима авторизация.

### 6. Удаление изображения

- **URL:** `/image/delete/{image_id}`
- **Метод:** `DELETE`
- **Описание:** Удаление изображения по его идентификатору.
- **Заголовки:**
    - `Authorization: Bearer {token}`
- **Параметры URL:**
    - `image_id`: идентификатор изображения
- **Ответ:**
    - **200 OK:** Запрос на удаление изображения отправлен на обработку.
    - **401 Unauthorized:** Необходима авторизация.


### Описание работы сервиса image_service

Сервис image_service отвечает за обработку изображений и взаимодействие с RabbitMQ для асинхронной обработки запросов на загрузку, обновление и удаление изображений. Ниже приведено подробное описание основных функций и их работы:

Основные компоненты

	1.	RabbitMQ: Используется как брокер сообщений для обработки событий, связанных с изображениями.
	2.	База данных: Хранит информацию о пользователях и изображениях.
	3.	Проверка пользователя: Все операции с изображениями требуют аутентификации пользователя.

Основные функции

	1.	Загрузка изображения (handle_upload_event):
	•	Принимает данные изображения, включая его имя, разрешение и размер.
	•	Декодирует изображение из формата Base64.
	•	Сохраняет изображение во временный файл.
	•	Загружает обработанное изображение в базу данных.
	•	Удаляет временный файл после завершения.

	2.	Обновление изображения (handle_update_event):
	•	Обрабатывает запросы на обновление информации о существующем изображении.
	•	Вносит изменения в базу данных в соответствии с новыми данными.
	
    3.	Удаление изображения (handle_delete_event):
	•	Удаляет запись изображения из базы данных по предоставленному идентификатору.
	4.	Слушатель сообщений (start_image_listener):
	•	Запускает соединение с RabbitMQ и ждет поступления сообщений.
	•	При получении сообщения обрабатывает его с помощью функции callback, которая вызывает process_image_action.

	5.	Обработка действий с изображениями (process_image_action):
	•	Дешифрует сообщение и определяет тип события (UPLOAD, UPDATE, DELETE).
	•	Выполняет соответствующее действие в зависимости от типа события и проверяет наличие пользователя в базе данных.

Пример работы

	1.	Пользователь регистрируется и получает токен доступа.
	2.	При загрузке изображения клиент отправляет запрос на /image/upload_image с токеном аутентификации.
	3.	Сервис получает сообщение о загрузке изображения через RabbitMQ.
	4.	Изображение обрабатывается и сохраняется в базе данных.
	5.	Сервис отправляет подтверждение о завершении обработки.